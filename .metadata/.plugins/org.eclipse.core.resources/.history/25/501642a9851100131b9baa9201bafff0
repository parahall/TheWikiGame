package com.example.wikigame;

import java.util.ArrayList;
import java.util.HashMap;

import android.app.Activity;
import android.app.AlertDialog;
import android.app.ProgressDialog;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.DialogInterface.OnCancelListener;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.LinearLayout;

import com.parse.FunctionCallback;
import com.parse.ParseCloud;
import com.parse.ParseException;
import com.parse.ParseObject;

public class GameActivity extends Activity {

	private ProgressDialog pd;
	private ArrayList<Button> btnList;
	private LinearLayout mainLayout;
	private HashMap<Button, Integer> dictinory;
	private Game game;

	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		btnList = new ArrayList<Button>();
		setContentView(R.layout.game_play);
		mainLayout = (LinearLayout) findViewById(R.id.layout_main);

		btnList.add((Button) findViewById(R.id.btn_source));
		btnList.add((Button) findViewById(R.id.btn_target1));
		btnList.add((Button) findViewById(R.id.btn_target2));
		btnList.add((Button) findViewById(R.id.btn_target3));
		btnList.add((Button) findViewById(R.id.btn_target4));
		Log.d("buildGame", "" + btnList.size());

		initializeTheGame();

	}

	private void initializeTheGame() {
		mainLayout.setVisibility(LinearLayout.GONE);
		pd = new ProgressDialog(this);
		pd.setTitle("Processing...");
		pd.setMessage("Please wait.");
		pd.setCancelable(true);
		pd.setOnCancelListener(new OnCancelListener() {

			@Override
			public void onCancel(DialogInterface dialog) {
				GameActivity.this.finish();
			}
		});
		pd.setIndeterminate(true);
		pd.show();
		HashMap<String, Object> param = new HashMap<String, Object>();

		ParseCloud.callFunctionInBackground("getGame", param,
				new FunctionCallback<HashMap<String, Object>>() {
					@Override
					public void done(HashMap<String, Object> object,
							ParseException e) {
						if (e == null) {
							Log.d("gameDebug", "succeed to obtain the game");
							StartGame(object);
						} else {
							popupAlertDialog(e);
						}
					}
				});

	}

	protected void StartGame(HashMap<String, Object> object) {
		game = parseGameFromObject(object);
		dictinory = new HashMap<Button, Integer>();
		btnList.get(0).setText(game.getSource().getTitle());
		for (int i = 0; i < game.getDestination().size(); i++) {
			btnList.get(i + 1).setText(game.getDestination().get(i).getTitle());
			dictinory.put(btnList.get(i + 1), game.getDestination().get(i)
					.getId());
		}
		pd.dismiss();
		mainLayout.setVisibility(LinearLayout.VISIBLE);

	}

	@SuppressWarnings("unchecked")
	private Game parseGameFromObject(HashMap<String, Object> object) {
		ArrayList<Article> articles = new ArrayList<Article>();
		Article source = new Article(
				((ParseObject) object.get("source")).getInt("article_id"),
				((ParseObject) object.get("source")).getString("title"));
		articles.add(source);

		ArrayList<ParseObject> destinations = (ArrayList<ParseObject>) object
				.get("destinations");
		for (ParseObject dest : destinations) {
			articles.add(new Article(dest.getInt("article_id"), dest
					.getString("title")));
		}

		ArrayList<Integer> shortPathlengths = (ArrayList<Integer>) object
				.get("articles_depth");
		Article winArticles = new Article(
				((ParseObject) object.get("winner_article"))
						.getInt("article_id"),
				((ParseObject) object.get("winner_article")).getString("title"));
		Game game = new Game(source, articles, shortPathlengths, winArticles);

		return game;
	}

	protected void popupAlertDialog(ParseException e) {
		Log.d("gameDebug", e.toString());
		AlertDialog.Builder alertDialogBuilder = new AlertDialog.Builder(this);
		alertDialogBuilder.setTitle("Failed to obtain new Game");
		alertDialogBuilder
				.setMessage(
						"Message: There is problem to retrieve new game from server of maybe there is no new game ready for you.\n Click yes to exit!")
				.setCancelable(false)
				.setPositiveButton("Yes",
						new DialogInterface.OnClickListener() {
							public void onClick(DialogInterface dialog, int id) {
								// if this button is clicked, close
								// current activity
								GameActivity.this.finish();
							}
						});

		// create alert dialog
		AlertDialog alertDialog = alertDialogBuilder.create();

		// show it
		alertDialog.show();
	}

	public void answerClicked(View v) {
		int gamesNumber = UserManager.getInstance().GetCurrentUser().getInt("gamesNumber");
		int winsNumber = UserManager.getInstance().GetCurrentUser().getInt("wins");
		UserManager.getInstance().GetCurrentUser().put("gamesNumber", gamesNumber++);
		int targetId = dictinory.get(v);
		if (targetId == game.getWinArticle().getId())
			popupMsg("win");
			UserManager.getInstance().GetCurrentUser().put("wins", winsNumber++);	
		else
			popupMsg("lost");

	}

	private void popupMsg(String string) {
		String shortest = "shortest";
		String congratulations = "Congratulations!";
		if (string == "lost"){
			shortest = "not " + shortest;
			congratulations = "Sorry :(";				
		}

		AlertDialog.Builder alertDialogBuilder = new AlertDialog.Builder(this);
		alertDialogBuilder.setTitle("You " + string + " a game");
		alertDialogBuilder
				.setMessage(
						"You have choose target article with " + shortest + " way!"+congratulations+"\nWould you like to play another game?")
				.setCancelable(true)
				.setPositiveButton("Yes",
						new DialogInterface.OnClickListener() {
							public void onClick(DialogInterface dialog, int id) {
								initializeTheGame();
							}
						})
				.setNegativeButton("No", new DialogInterface.OnClickListener() {
					public void onClick(DialogInterface dialog, int id) {
						GameActivity.this.finish();
					}
				});

		// create alert dialog
		AlertDialog alertDialog = alertDialogBuilder.create();

		// show it
		alertDialog.show();

	}

}
